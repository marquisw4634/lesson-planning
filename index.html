<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Planning App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better appearance */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Google Fonts Imports */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap');

        /* Default Font for body (can be overridden by themes) */
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-roboto-slab { font-family: 'Roboto Slab', serif; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        .font-merriweather { font-family: 'Merriweather', serif; }
        .font-space-mono { font-family: 'Space Mono', monospace; }
        .font-lora { font-family: 'Lora', serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-playfair-display { font-family: 'Playfair Display', serif; }


        /* Basic styles for draggable elements feedback */
        .dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1; /* Tailwind indigo-500 */
        }
        .droppable-date.highlight-drop {
            border: 2px solid #3b82f6; /* Tailwind blue-500 */
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        /* Explicit style for the day header strip to ensure visibility */
        .day-header-strip {
            padding: 0.25rem;
        }
        /* Student View specific styles */
        .student-view-day-card {
            text-align: center; /* Center text in student view day cards */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to top */
            align-items: center; /* Center horizontally */
        }
        /* Tab specific styles */
        .tab-item {
            cursor: pointer;
            border-bottom: none;
            position: relative;
            z-index: 10; /* Ensure tabs are above main content */
            margin-bottom: -1px; /* Overlap with content border */
        }
        .tab-item.active {
            border-bottom: 1px solid transparent; /* Hide bottom border when active */
            z-index: 11;
        }
    </style>
</head>
<body>
    <div id="app-root" class="min-h-screen font-inter flex flex-col"></div>

    <script>
        // --- Global State Variables ---
        let units = [];
        let lessons = [];
        let selectedUnit = null;
        let currentView = 'listView'; // listView, weeklyView, monthlyView
        let currentTheme = 'default';
        let localUserId = ''; // For local storage, a persistent 'user ID'
        let isWeeklyStudentView = false; // New state for weekly view toggle
        let userTabs = []; // New global state for custom tabs

        // --- Utility Functions ---

        // Utility to escape HTML for attribute values
        const escapeHtml = (unsafe) => {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // Function to format dates
        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        };

        // Function for robust date comparison (year, month, day)
        const isSameDay = (date1, date2) => {
            if (!date1 || !date2) return false;
            const d1String = (date1 instanceof Date) ? date1.toISOString().split('T')[0] : date1;
            const d2String = (date2 instanceof Date) ? date2.toISOString().split('T')[0] : date2;
            return d1String === d2String;
        };

        // Function to get all weekdays between two dates
        const getWeekdaysInRange = (startDate, endDate) => {
            const dates = [];
            // Ensure startDate and endDate are interpreted as local dates for iteration
            let current = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            while (current <= end) {
                const dayOfWeek = current.getDay(); // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Sunday (0) and Saturday (6)
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };

        // Function to render clickable links from a comma-separated string
        const renderClickableLinks = (linksString) => {
            if (!linksString) return '';
            const links = linksString.split(',').map(link => link.trim()).filter(link => link !== '');
            return links.map(link => {
                let validLink = link;
                if (!link.startsWith('http://') && !link.startsWith('https://')) {
                    validLink = 'https://' + link;
                }
                // Use a smaller text size and block display for better wrapping
                return `<a href="${escapeHtml(validLink)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline text-xs block break-all">${escapeHtml(link)}</a>`;
            }).join(''); // No <br> needed due to block display
        };

        // --- Theme Definitions ---
        const themes = {
            default: {
                primaryBg: 'bg-blue-50',
                secondaryBg: 'bg-white',
                textColor: 'text-gray-800',
                accentColor: 'bg-blue-600 text-white',
                borderColor: 'border-blue-200',
                hoverBg: 'hover:bg-blue-100',
                buttonBg: 'bg-blue-500 hover:bg-blue-600 text-white',
                inputBorder: 'border-gray-300 focus:border-blue-500',
                gradedBg: 'bg-red-100',
                gradedBorder: 'border-red-400',
                fontFamily: 'font-inter',
            },
            earthy: {
                primaryBg: 'bg-amber-50',
                secondaryBg: 'bg-white',
                textColor: 'text-stone-800',
                accentColor: 'bg-green-700 text-white',
                borderColor: 'border-amber-200',
                hoverBg: 'hover:bg-amber-100',
                buttonBg: 'bg-green-600 hover:bg-green-700 text-white',
                inputBorder: 'border-stone-300 focus:border-green-600',
                gradedBg: 'bg-red-100',
                gradedBorder: 'border-red-400',
                fontFamily: 'font-merriweather',
            },
            maine: {
                primaryBg: 'bg-blue-100', /* Lighter, breezier blue */
                secondaryBg: 'bg-white',
                textColor: 'text-gray-800',
                accentColor: 'bg-green-700 text-white', /* Deep forest green */
                borderColor: 'border-blue-300',
                hoverBg: 'hover:bg-blue-200',
                buttonBg: 'bg-green-600 hover:bg-green-700 text-white',
                inputBorder: 'border-gray-300 focus:border-green-500',
                gradedBg: 'bg-teal-100', /* Soft teal for graded */
                gradedBorder: 'border-teal-400',
                fontFamily: 'font-montserrat',
            },
            // New Theme: MobileClean (iOS/Android inspired)
            mobileClean: {
                primaryBg: 'bg-gray-50', /* Very light gray */
                secondaryBg: 'bg-white', /* Pure white cards */
                textColor: 'text-gray-700', /* Soft dark gray for text */
                accentColor: 'bg-blue-600 text-white', /* Vibrant blue accent */
                borderColor: 'border-gray-200', /* Subtle light gray borders */
                hoverBg: 'hover:bg-gray-100',
                buttonBg: 'bg-blue-500 hover:bg-blue-600 text-white',
                inputBorder: 'border-gray-300 focus:border-blue-500',
                gradedBg: 'bg-blue-50', /* Very light blue for graded */
                gradedBorder: 'border-blue-300',
                fontFamily: 'font-lato', /* Clean sans-serif */
            },
        };

        // --- Message Display Function ---
        let messageTimeoutId = null;
        const showAppMessage = (msg, type) => {
            const appRoot = document.getElementById('app-root');
            let messageDiv = document.getElementById('app-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'app-message';
                messageDiv.className = 'absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
                appRoot.appendChild(messageDiv);
            }

            messageDiv.textContent = msg;
            messageDiv.className = `absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            messageDiv.style.opacity = '1';

            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
            }
            messageTimeoutId = setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300); // Allow fade out before removal
            }, 3000);
        };

        // --- Local Storage Management ---
        const saveState = () => {
            try {
                localStorage.setItem('lessonPlannerUnits', JSON.stringify(units));
                localStorage.setItem('lessonPlannerLessons', JSON.stringify(lessons));
                localStorage.setItem('lessonPlannerUserTabs', JSON.stringify(userTabs)); // Save user tabs
            } catch (e) {
                console.error("Failed to save data to local storage:", e);
                showAppMessage("Error saving data to local storage.", 'error');
            }
        };

        const loadState = () => {
            try {
                units = JSON.parse(localStorage.getItem('lessonPlannerUnits') || '[]');
                lessons = JSON.parse(localStorage.getItem('lessonPlannerLessons') || '[]');
                userTabs = JSON.parse(localStorage.getItem('lessonPlannerUserTabs') || '[]'); // Load user tabs
                
                // Initialize localUserId if not present
                if (!localStorage.getItem('lessonPlannerUserId')) {
                    localStorage.setItem('lessonPlannerUserId', crypto.randomUUID());
                }
                localUserId = localStorage.getItem('lessonPlannerUserId');

                if (units.length > 0) {
                    selectedUnit = units[0];
                } else {
                    selectedUnit = null;
                }
            } catch (e) {
                console.error("Failed to load data from local storage:", e);
                showAppMessage("Error loading data from local storage. Your data might be corrupted.", 'error');
            }
        };

        // --- Core Application Logic (Unit/Lesson Management) ---

        const addUnit = (unitName, startDate, endDate) => {
            const newUnit = {
                id: crypto.randomUUID(),
                name: unitName,
                startDate: startDate ? startDate.toISOString().split('T')[0] : null,
                endDate: endDate ? endDate.toISOString().split('T')[0] : null,
                order: units.length,
            };
            units.push(newUnit);
            units.sort((a, b) => a.order - b.order); // Keep sorted
            if (!selectedUnit) {
                selectedUnit = newUnit;
            }
            saveState();
            renderApp();
            showAppMessage('Unit added successfully!', 'success');
        };

        const updateUnitDates = (unitId, newStartDateObj, newEndDateObj) => {
            units = units.map(unit => {
                if (unit.id === unitId) {
                    const oldStartDateObj = unit.startDate ? new Date(unit.startDate + 'T00:00:00') : null;
                    
                    let finalStartDate = newStartDateObj;
                    let finalEndDate = newEndDateObj;

                    // Find the latest lesson date for this unit
                    const lessonsInUnit = lessons.filter(lesson => lesson.unitId === unitId);
                    let latestLessonDateObj = null;
                    if (lessonsInUnit.length > 0) {
                        latestLessonDateObj = new Date(Math.max(...lessonsInUnit.map(lesson => new Date(lesson.date + 'T00:00:00'))));
                    }

                    // Adjust finalEndDate if it cuts off lessons
                    if (latestLessonDateObj && finalEndDate && latestLessonDateObj > finalEndDate) {
                        finalEndDate = latestLessonDateObj;
                    }
                    // Also ensure finalEndDate is not before finalStartDate
                    if (finalStartDate && finalEndDate && finalStartDate > finalEndDate) {
                        finalEndDate = finalStartDate;
                    }

                    // Calculate day difference for shifting lessons
                    let dayDiff = 0;
                    if (oldStartDateObj && finalStartDate) {
                        // Calculate difference in milliseconds, then convert to days
                        dayDiff = Math.round((finalStartDate.getTime() - oldStartDateObj.getTime()) / (1000 * 60 * 60 * 24));
                    }

                    // Shift lessons if there's a day difference in the unit start date
                    if (dayDiff !== 0) {
                        lessons = lessons.map(lesson => {
                            if (lesson.unitId === unitId) {
                                const lessonDateObj = new Date(lesson.date + 'T00:00:00');
                                lessonDateObj.setDate(lessonDateObj.getDate() + dayDiff);
                                
                                // Adjust if new date falls on a weekend
                                let newDayOfWeek = lessonDateObj.getDay();
                                if (newDayOfWeek === 0) { // Sunday
                                    lessonDateObj.setDate(lessonDateObj.getDate() + 1); // Move to Monday
                                } else if (newDayOfWeek === 6) { // Saturday
                                    lessonDateObj.setDate(lessonDateObj.getDate() + 2); // Move to Monday
                                }

                                return {
                                    ...lesson,
                                    date: lessonDateObj.toISOString().split('T')[0],
                                };
                            }
                            return lesson;
                        });
                    }

                    return {
                        ...unit,
                        startDate: finalStartDate ? finalStartDate.toISOString().split('T')[0] : null,
                        endDate: finalEndDate ? finalEndDate.toISOString().split('T')[0] : null,
                    };
                }
                return unit;
            });
            // Update selectedUnit to reference the newly updated object from the units array
            selectedUnit = units.find(u => u.id === unitId);
            saveState();
            renderApp();
            showAppMessage('Unit dates updated successfully!', 'success');
        };

        const deleteUnit = (unitId) => {
            const lessonsInUnit = lessons.filter(lesson => lesson.unitId === unitId);
            if (lessonsInUnit.length > 0) {
                showAppMessage('Cannot delete unit: Please delete all lessons within this unit first.', 'error');
                return;
            }
            units = units.filter(unit => unit.id !== unitId);
            if (selectedUnit && selectedUnit.id === unitId) {
                selectedUnit = units.length > 0 ? units[0] : null;
            }
            saveState();
            renderApp();
            showAppMessage('Unit deleted successfully!', 'success');
        };

        const reorderUnits = (newOrder) => {
            units = newOrder.map((unit, index) => ({ ...unit, order: index }));
            saveState();
            renderApp();
        };

        const addLesson = (lessonData) => {
            if (!selectedUnit) {
                showAppMessage('Please select a unit first.', 'error');
                return;
            }
            const newLesson = {
                id: crypto.randomUUID(),
                ...lessonData,
                unitId: selectedUnit.id,
                date: lessonData.date, // Already ISO-formatted date string
                order: lessons.filter(l => l.unitId === selectedUnit.id && isSameDay(l.date, lessonData.date)).length,
            };
            lessons.push(newLesson);
            saveState();
            renderApp();
            showAppMessage('Lesson added successfully!', 'success');
        };

        const updateLesson = (lessonId, updatedData) => {
            lessons = lessons.map(lesson =>
                lesson.id === lessonId
                    ? { ...lesson, ...updatedData, date: updatedData.date }
                    : lesson
            );
            saveState();
            renderApp();
            showAppMessage('Lesson updated successfully!', 'success');
        };

        const deleteLesson = (lessonId) => {
            lessons = lessons.filter(lesson => lesson.id !== lessonId);
            saveState();
            renderApp();
            showAppMessage('Lesson deleted successfully!', 'success');
        };

        const reorderLesson = (lessonId, newDateObj, newOrder) => {
            console.log(`Reordering lesson ${lessonId} to date ${newDateObj.toISOString().split('T')[0]} with requested order ${newOrder}`);
            let allLessonsCopy = [...lessons]; // Start with the global lessons array

            // 1. Find and remove the dragged lesson
            let draggedLessonIndex = allLessonsCopy.findIndex(l => l.id === lessonId);
            if (draggedLessonIndex === -1) {
                console.error("ReorderLesson: Dragged lesson not found in lessons array.");
                return; // Should not happen
            }
            let draggedLesson = allLessonsCopy.splice(draggedLessonIndex, 1)[0];
            console.log("Dragged lesson removed:", draggedLesson);

            // 2. Update its date
            draggedLesson.date = newDateObj.toISOString().split('T')[0];
            console.log("Dragged lesson new date:", draggedLesson.date);

            // 3. Add it back to the array
            allLessonsCopy.push(draggedLesson);
            console.log("Dragged lesson re-added. Array length:", allLessonsCopy.length);

            // 4. Re-index ALL lessons within the selected unit based on their date and then their current order
            const lessonsInSelectedUnit = allLessonsCopy.filter(l => l.unitId === selectedUnit.id)
                                                       .sort((a, b) => {
                                                           // Sort by date first
                                                           const dateA = new Date(a.date + 'T00:00:00');
                                                           const dateB = new Date(b.date + 'T00:00:00');
                                                           if (dateA.getTime() !== dateB.getTime()) {
                                                               return dateA.getTime() - dateB.getTime();
                                                           }
                                                           // Then by existing order for lessons on the same day
                                                           return a.order - b.order;
                                                       });
            console.log("Lessons in selected unit (sorted):", lessonsInSelectedUnit.map(l => ({id: l.id, date: l.date, order: l.order})));

            // Re-assign `order` property for lessons within the selected unit
            lessonsInSelectedUnit.forEach((lesson, index) => {
                lesson.order = index;
            });
            console.log("Lessons in selected unit (re-ordered):", lessonsInSelectedUnit.map(l => ({id: l.id, date: l.date, order: l.order})));


            // Combine lessons from the selected unit with lessons from other units
            lessons = allLessonsCopy.filter(l => l.unitId !== selectedUnit.id).concat(lessonsInSelectedUnit);
            console.log("Final lessons array length:", lessons.length);

            saveState();
            renderApp();
            showAppMessage('Lesson reordered successfully!', 'success');
        };

        // --- Modals ---
        const openModal = (type, data = {}) => {
            const appRoot = document.getElementById('app-root');
            let modalOverlay = document.getElementById('modal-overlay');
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.id = 'modal-overlay';
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) closeModal();
                });
                appRoot.appendChild(modalOverlay);
            }

            const theme = themes[currentTheme];
            const modalContent = document.createElement('div');
            modalContent.className = `${theme.secondaryBg} p-6 rounded-xl shadow-2xl max-w-lg w-full relative`;
            modalOverlay.innerHTML = ''; // Clear previous content
            modalOverlay.appendChild(modalContent);

            const closeButton = document.createElement('button');
            closeButton.className = 'absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold';
            closeButton.innerHTML = '&times;';
            closeButton.addEventListener('click', closeModal);
            modalContent.appendChild(closeButton);

            let formElement;
            if (type === 'addUnit') {
                formElement = createAddUnitForm();
            } else if (type === 'addLesson' || type === 'editLesson') {
                formElement = createLessonForm(type, data);
            } else if (type === 'confirmDeleteUnit') {
                formElement = createConfirmDeleteUnitModal(data);
            } else if (type === 'tabSettings') { // New: Tab Settings Modal
                formElement = createTabSettingsForm();
            }
            modalContent.appendChild(formElement);
        };

        const closeModal = () => {
            const modalOverlay = document.getElementById('modal-overlay');
            if (modalOverlay && modalOverlay.parentNode) {
                modalOverlay.parentNode.removeChild(modalOverlay);
            }
            renderApp(); // Re-render the main app to update UI
        };

        const createAddUnitForm = () => {
            const theme = themes[currentTheme];
            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Add New Unit</h2>
                <div>
                    <label for="unitName" class="block text-sm font-medium mb-1">Unit Title:</label>
                    <input type="text" id="unitName" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" required />
                </div>
                <div>
                    <label for="unitStartDate" class="block text-sm font-medium mb-1">Start Date (Optional):</label>
                    <input type="date" id="unitStartDate" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                </div>
                <div>
                    <label for="unitEndDate" class="block text-sm font-medium mb-1">End Date (Optional):</label>
                    <input type="date" id="unitEndDate" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelAddUnit" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">Add Unit</button>
                </div>
            `;
            form.querySelector('#cancelAddUnit').addEventListener('click', closeModal);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const unitName = form.querySelector('#unitName').value.trim();
                const startDate = form.querySelector('#unitStartDate').value;
                const endDate = form.querySelector('#unitEndDate').value;
                if (!unitName) {
                    showAppMessage('Unit name cannot be empty.', 'error');
                    return;
                }
                addUnit(unitName, startDate ? new Date(startDate + 'T00:00:00') : null, endDate ? new Date(endDate + 'T00:00:00') : null);
                closeModal();
            });
            return form;
        };

        const createLessonForm = (type, initialData = {}) => {
            const theme = themes[currentTheme];
            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${type === 'editLesson' ? 'Edit Lesson' : 'Add New Lesson'}</h2>
                <div>
                    <label for="lessonTitle" class="block text-sm font-medium mb-1">Lesson Title:</label>
                    <input type="text" id="lessonTitle" value="${escapeHtml(initialData.title || '')}" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" required />
                </div>
                <div>
                    <label for="lessonDate" class="block text-sm font-medium mb-1">Date:</label>
                    <input type="date" id="lessonDate" value="${initialData.date || ''}" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" required />
                </div>
                <div>
                    <label for="googleSlidesLink" class="block text-sm font-medium mb-1">Google Slides Link:</label>
                    <input type="url" id="googleSlidesLink" value="${escapeHtml(initialData.googleSlidesLink || '')}" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" placeholder="e.g., https://docs.google.com/presentation/d/..." />
                </div>
                <div>
                    <label for="activityAssignment" class="block text-sm font-medium mb-1">Activity/Assignment:</label>
                    <input type="text" id="activityAssignment" value="${escapeHtml(initialData.activityAssignment || '')}" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="isGraded" ${initialData.isGraded ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                    <label for="isGraded" class="text-sm font-medium">Graded Assignment</label>
                </div>
                <div>
                    <label for="readings" class="block text-sm font-medium mb-1">Readings:</label>
                    <textarea id="readings" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" rows="2">${escapeHtml(initialData.readings || '')}</textarea>
                </div>
                <div>
                    <label for="additionalLinks" class="block text-sm font-medium mb-1">Additional Links (comma-separated):</label>
                    <textarea id="additionalLinks" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" rows="2">${escapeHtml(initialData.additionalLinks || '')}</textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelLessonForm" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">${type === 'editLesson' ? 'Save Changes' : 'Add Lesson'}</button>
                </div>
            `;
            form.querySelector('#cancelLessonForm').addEventListener('click', closeModal);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    title: form.querySelector('#lessonTitle').value.trim(),
                    date: form.querySelector('#lessonDate').value, // ISO-formatted date string
                    googleSlidesLink: form.querySelector('#googleSlidesLink').value,
                    activityAssignment: form.querySelector('#activityAssignment').value,
                    isGraded: form.querySelector('#isGraded').checked,
                    readings: form.querySelector('#readings').value,
                    additionalLinks: form.querySelector('#additionalLinks').value,
                };
                if (!data.title) {
                    showAppMessage('Lesson title cannot be empty.', 'error');
                    return;
                }
                if (type === 'editLesson') {
                    updateLesson(initialData.id, data);
                } else {
                    addLesson(data);
                }
                closeModal();
            });
            return form;
        };

        const createConfirmDeleteUnitModal = (unit) => {
            const theme = themes[currentTheme];
            const div = document.createElement('div');
            div.className = 'space-y-4 text-center';
            div.innerHTML = `
                <h2 class="text-xl font-bold">Confirm Deletion</h2>
                <p>Are you sure you want to delete the unit "<span class="font-semibold">${escapeHtml(unit.name)}</span>"?</p>
                <p class="text-red-600 font-semibold">This action cannot be undone.</p>
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="button" id="cancelDeleteUnit" class="px-6 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out">Cancel</button>
                    <button type="button" id="confirmDeleteUnit" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105">Delete</button>
                </div>
            `;
            div.querySelector('#cancelDeleteUnit').addEventListener('click', closeModal);
            div.querySelector('#confirmDeleteUnit').addEventListener('click', () => {
                deleteUnit(unit.id);
                closeModal();
            });
            return div;
        };

        // --- Tab Settings Modal ---
        const createTabSettingsForm = () => {
            const theme = themes[currentTheme];
            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Manage Custom Tabs</h2>
                <div id="tabInputs" class="space-y-3"></div>
                <div class="flex justify-between space-x-2 mt-6">
                    <button type="button" id="clearAllTabs" class="px-4 py-2 rounded-xl border border-red-300 text-red-700 hover:bg-red-100 transition duration-200 ease-in-out">Clear All Tabs</button>
                    <div class="flex space-x-2">
                        <button type="button" id="cancelTabSettings" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">Save Tabs</button>
                    </div>
                </div>
            `;

            const tabInputsContainer = form.querySelector('#tabInputs');
            for (let i = 0; i < 5; i++) {
                const tab = userTabs[i] || { label: '', url: '' };
                const tabGroup = document.createElement('div');
                tabGroup.className = 'tab-group flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2';
                tabGroup.innerHTML = `
                    <input type="text" placeholder="Tab Label ${i + 1}" value="${escapeHtml(tab.label)}" class="tab-label w-full sm:w-1/3 p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                    <input type="url" placeholder="Tab URL ${i + 1}" value="${escapeHtml(tab.url)}" class="tab-url w-full sm:w-2/3 p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                `;
                tabInputsContainer.appendChild(tabGroup);
            }

            form.querySelector('#cancelTabSettings').addEventListener('click', closeModal);
            form.querySelector('#clearAllTabs').addEventListener('click', () => {
                userTabs = [];
                saveState();
                closeModal();
                showAppMessage('All custom tabs cleared!', 'success');
            });
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const newTabs = [];
                form.querySelectorAll('.tab-group').forEach((group) => {
                    const label = group.querySelector('.tab-label').value.trim();
                    const url = group.querySelector('.tab-url').value.trim();
                    if (label && url) {
                        newTabs.push({ label, url });
                    }
                });
                userTabs = newTabs;
                saveState();
                closeModal();
                showAppMessage('Custom tabs saved!', 'success');
            });
            return form;
        };


        // --- Drag and Drop Logic ---
        let draggedElement = null; // Stores the HTML element being dragged
        
        const handleDragStart = (e) => {
            draggedElement = e.target.closest('.draggable-lesson');
            if (!draggedElement) {
                console.warn("DragStart: Event target or its ancestor is not a .draggable-lesson.", e.target);
                return;
            }
            
            const droppableId = draggedElement.dataset.droppableId; // Get droppableId directly from the lesson element
            if (!droppableId) {
                console.error("DragStart Error: Draggable lesson found, but missing data-droppable-id attribute. Drag operation aborted.");
                console.error("Dragged Element:", draggedElement);
                e.preventDefault(); // Prevent the drag operation
                draggedElement.classList.remove('dragging'); // Remove dragging class
                draggedElement = null;
                return;
            }

            e.dataTransfer.setData('lessonId', draggedElement.dataset.lessonId);
            e.dataTransfer.setData('sourceDroppableId', droppableId); // Store the source droppable ID (YYYY-MM-DD)
            e.dataTransfer.effectAllowed = 'move';
            draggedElement.classList.add('dragging'); // Add dragging class after data is set
            console.log(`DragStart: Lesson ID: ${draggedElement.dataset.lessonId}, Source Droppable ID: ${droppableId}`);
        };

        const handleDragOver = (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            const targetDroppable = e.target.closest('.droppable-date');
            if (targetDroppable) {
                targetDroppable.classList.add('highlight-drop'); // Add highlight
            }
        };

        const handleDragLeave = (e) => {
            const targetDroppable = e.target.closest('.droppable-date');
            if (targetDroppable) {
                targetDroppable.classList.remove('highlight-drop'); // Remove highlight
            }
        };

        const handleDrop = (e) => {
            e.preventDefault();
            const destinationDroppable = e.target.closest('.droppable-date');
            if (!destinationDroppable) {
                console.warn("Drop: No droppable-date found at drop target.");
                return;
            }

            const lessonId = e.dataTransfer.getData('lessonId');
            const sourceDroppableId = e.dataTransfer.getData('sourceDroppableId');
            const destinationDroppableId = destinationDroppable.dataset.droppableId; // This is now
            const destinationDate = new Date(destinationDroppableId + 'T00:00:00'); // Convert to Date object reliably

            console.log(`Drop: Lesson ID: ${lessonId}, Source Date: ${sourceDroppableId}, Destination Date: ${destinationDroppableId}`);

            // --- IMPORTANT: Validate if drop is within the unit's date range ---
            if (selectedUnit && selectedUnit.startDate && selectedUnit.endDate) {
                const unitStartDate = new Date(selectedUnit.startDate + 'T00:00:00');
                const unitEndDate = new Date(selectedUnit.endDate + 'T00:00:00');

                // Check if destinationDate is within the unit's start and end dates (inclusive)
                if (destinationDate < unitStartDate || destinationDate > unitEndDate) {
                    showAppMessage('Cannot move lesson outside of unit date range.', 'error');
                    console.warn(`Drop aborted: Destination date ${destinationDroppableId} is outside unit range ${selectedUnit.startDate} - ${selectedUnit.endDate}`);
                    // Clean up drag visual feedback
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                    }
                    destinationDroppable.classList.remove('highlight-drop');
                    draggedElement = null;
                    return; // Abort the drop operation
                }
            }


            // Determine the drop index within the destination list
            // Find all lessons currently on the destination date (excluding the one being dragged if it's dropping on its original date)
            const lessonsOnDestinationDateElements = Array.from(destinationDroppable.querySelectorAll('.draggable-lesson:not(.dragging)'));
            
            let newOrder = lessonsOnDestinationDateElements.length; // Default to end if no specific target
            
            // Find the element closest to the drop point for precise insertion
            const droppedY = e.clientY;
            let closestElement = null;
            let minDistance = Infinity;

            for (const el of lessonsOnDestinationDateElements) {
                const rect = el.getBoundingClientRect();
                // Calculate distance to the center of the element
                const distance = Math.abs(droppedY - (rect.top + rect.height / 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    closestElement = el;
                }
            }

            if (closestElement) {
                const closestElementIndex = lessonsOnDestinationDateElements.indexOf(closestElement);
                const rect = closestElement.getBoundingClientRect();
                // If dropped below the midpoint of the closest element, insert after it
                if (droppedY > rect.top + rect.height / 2) {
                    newOrder = closestElementIndex + 1; 
                } else {
                    newOrder = closestElementIndex; // Otherwise, insert before it
                }
            }
            console.log(`Drop calculated newOrder: ${newOrder}`);

            reorderLesson(lessonId, destinationDate, newOrder);
            
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            // Remove highlight from destination droppable
            destinationDroppable.classList.remove('highlight-drop');
            draggedElement = null;
        };

        const handleDragEnd = (e) => {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            draggedElement = null;
            // Ensure all droppable areas reset their highlight
            document.querySelectorAll('.droppable-date').forEach(el => {
                el.classList.remove('highlight-drop');
            });
            console.log("DragEnd: Cleaning up.");
        };


        // --- UI Rendering Functions ---

        const renderApp = () => {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = ''; // Clear previous content

            const theme = themes[currentTheme];
            appRoot.className = `min-h-screen ${theme.primaryBg} ${theme.textColor} ${theme.fontFamily} flex flex-col`; // Apply font family here

            // --- Top Tabs Section ---
            const tabsContainer = document.createElement('div');
            tabsContainer.className = `flex border-b ${theme.borderColor} px-4 pt-2`;
            appRoot.appendChild(tabsContainer);

            // Custom Tabs (Lesson Planner tab is removed as per request)
            userTabs.forEach((tab, index) => {
                if (tab.label && tab.url) {
                    const customTab = document.createElement('div');
                    // No 'active' class for custom tabs as they open in new window
                    customTab.className = `tab-item px-4 py-2 rounded-t-lg border-t border-x ${theme.borderColor} ${theme.secondaryBg}`;
                    customTab.textContent = tab.label;
                    customTab.addEventListener('click', () => {
                        window.open(tab.url, '_blank'); // Open in new browser tab
                    });
                    tabsContainer.appendChild(customTab);
                }
            });

            // Header (now below tabs)
            const headerElement = document.createElement('header');
            headerElement.className = `p-4 shadow-md ${theme.secondaryBg} rounded-b-xl`;
            headerElement.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold mb-2 md:mb-0">Lesson Planner</h1>
                    <div class="flex items-center space-x-4">
                        <p class="text-sm">User ID: <span class="font-mono text-xs break-all">${localUserId || 'N/A'}</span></p>
                        <button id="menuButton" class="px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">Menu</button>
                    </div>
                </div>
                <div id="unitBar" class="flex overflow-x-auto py-2 space-x-2 scrollbar-hide"></div>
            `;
            appRoot.appendChild(headerElement);

            // Menu Overlay (initially hidden)
            const menuOverlay = document.createElement('div');
            menuOverlay.id = 'menuOverlay';
            menuOverlay.className = `absolute right-4 mt-2 w-48 ${theme.secondaryBg} rounded-xl shadow-lg z-50 p-4 hidden`;
            menuOverlay.innerHTML = `
                <h3 class="font-bold mb-2">Views</h3>
                <ul class="space-y-1 mb-4">
                    <li><button data-view="listView" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">List View</button></li>
                    <li><button data-view="weeklyView" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">Weekly View</button></li> <!-- Re-added weekly view option -->
                    <li><button data-view="monthlyView" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">Monthly Calendar View</button></li>
                </ul>
                <h3 class="font-bold mb-2">Themes</h3>
                <select id="themeSelect" class="w-full p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}"></select>
                <h3 class="font-bold mb-2 mt-4">Data Management</h3>
                <ul class="space-y-1">
                    <li><button id="exportDataButton" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">Export Data</button></li>
                    <li><button id="importDataButton" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">Import Data</button></li>
                    <li><button id="manageTabsButton" class="w-full text-left py-1 px-2 rounded ${theme.hoverBg}">Manage Custom Tabs</button></li> <!-- New tab management button -->
                    <input type="file" id="importFileInput" accept=".json" class="hidden" />
                </ul>
            `;
            headerElement.appendChild(menuOverlay);

            // Populate theme select
            const themeSelect = menuOverlay.querySelector('#themeSelect');
            for (const themeName in themes) {
                // Filter out liquidGlass as it was problematic
                if (themeName === 'liquidGlass') continue; 
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                themeSelect.appendChild(option);
            }
            themeSelect.value = currentTheme; // Set current theme

            // Event listeners for menu
            headerElement.querySelector('#menuButton').addEventListener('click', () => {
                menuOverlay.classList.toggle('hidden');
            });
            menuOverlay.querySelectorAll('[data-view]').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentView = e.target.dataset.view;
                    menuOverlay.classList.add('hidden');
                    renderApp();
                });
            });
            themeSelect.addEventListener('change', (e) => {
                currentTheme = e.target.value;
                menuOverlay.classList.add('hidden');
                renderApp();
            });
            menuOverlay.querySelector('#exportDataButton').addEventListener('click', () => {
                handleExportData();
                menuOverlay.classList.add('hidden');
            });
            menuOverlay.querySelector('#importDataButton').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
                menuOverlay.classList.add('hidden');
            });
            document.getElementById('importFileInput').addEventListener('change', handleImportData);
            menuOverlay.querySelector('#manageTabsButton').addEventListener('click', () => { // New tab management listener
                openModal('tabSettings');
                menuOverlay.classList.add('hidden');
            });


            // Unit Bar
            const unitBar = headerElement.querySelector('#unitBar');
            units.forEach((unitItem, index) => {
                const unitDiv = document.createElement('div');
                unitDiv.className = `flex-shrink-0 px-4 py-2 rounded-xl cursor-pointer transition duration-200 ease-in-out ${selectedUnit && selectedUnit.id === unitItem.id ? theme.accentColor : `${theme.secondaryBg} ${theme.borderColor} border`} ${theme.hoverBg}`;
                unitDiv.textContent = unitItem.name;
                unitDiv.dataset.unitId = unitItem.id;
                unitDiv.draggable = true; // Re-enabled drag for units

                unitDiv.addEventListener('click', () => {
                    selectedUnit = unitItem;
                    renderApp();
                });
                unitDiv.addEventListener('dragstart', (e) => { // Re-enabled drag for units
                    e.dataTransfer.setData('unitId', unitItem.id);
                    e.dataTransfer.setData('unitIndex', index);
                    e.dataTransfer.effectAllowed = 'move';
                    unitDiv.classList.add('dragging');
                });
                unitDiv.addEventListener('dragover', (e) => { // Re-enabled drag for units
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                unitDiv.addEventListener('drop', (e) => { // Re-enabled drag for units
                    e.preventDefault();
                    const draggedUnitId = e.dataTransfer.getData('unitId');
                    const draggedUnitIndex = parseInt(e.dataTransfer.getData('unitIndex'), 10);
                    const droppedOnUnitId = unitItem.id;
                    const droppedOnUnitIndex = index;

                    if (draggedUnitId === droppedOnUnitId) return;

                    const reorderedUnitsArray = Array.from(units);
                    const [removed] = reorderedUnitsArray.splice(draggedUnitIndex, 1);
                    reorderedUnitsArray.splice(droppedOnUnitIndex, 0, removed);

                    reorderUnits(reorderedUnitsArray);
                });
                unitDiv.addEventListener('dragend', (e) => { // Re-enabled drag for units
                    unitDiv.classList.remove('dragging');
                });
                unitBar.appendChild(unitDiv);
            });

            const addUnitButton = document.createElement('button');
            addUnitButton.className = `${theme.buttonBg} flex-shrink-0 px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105`;
            addUnitButton.textContent = '+ Add Unit';
            addUnitButton.addEventListener('click', () => openModal('addUnit'));
            unitBar.appendChild(addUnitButton);


            // Main Content Area
            const mainContent = document.createElement('main');
            mainContent.className = 'flex-1 p-4 overflow-auto';
            appRoot.appendChild(mainContent);

            if (selectedUnit) {
                renderLessonPlanner(mainContent);
            } else {
                const noUnitMessage = document.createElement('div');
                noUnitMessage.className = 'flex flex-col items-center justify-center h-full text-center py-20';
                noUnitMessage.innerHTML = `
                    <p class="text-xl font-semibold mb-4">No unit selected or created yet.</p>
                    <button id="addFirstUnitButton" class="px-6 py-3 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">Add Your First Unit</button>
                `;
                noUnitMessage.querySelector('#addFirstUnitButton').addEventListener('click', () => openModal('addUnit'));
                mainContent.appendChild(noUnitMessage);
            }
        };

        const renderLessonPlanner = (parentElement) => {
            parentElement.innerHTML = '';
            const theme = themes[currentTheme];

            const plannerDiv = document.createElement('div');
            plannerDiv.className = `p-4 rounded-xl shadow-lg ${theme.secondaryBg}`;
            parentElement.appendChild(plannerDiv);

            const headerDiv = document.createElement('div');
            headerDiv.className = `flex justify-between items-center mb-4 pb-4 border-b-2 border-dashed`;
            headerDiv.style.borderColor = theme.borderColor.split('-').pop();
            headerDiv.innerHTML = `
                <h2 class="text-2xl font-bold">${escapeHtml(selectedUnit.name)}</h2>
                <button id="deleteUnitButton" class="text-red-500 hover:text-red-700 font-semibold transition duration-200 ease-in-out">Delete Unit</button>
            `;
            plannerDiv.appendChild(headerDiv);
            headerDiv.querySelector('#deleteUnitButton').addEventListener('click', () => openModal('confirmDeleteUnit', selectedUnit));

            const dateRangeDiv = document.createElement('div');
            dateRangeDiv.className = `mb-6 p-4 rounded-lg border-2`;
            dateRangeDiv.style.borderColor = theme.borderColor.split('-').pop();
            dateRangeDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">Unit Date Range</h3>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label class="flex items-center space-x-2">
                        <span>Start Date:</span>
                        <input type="date" id="unitStartDateInput" value="${selectedUnit.startDate || ''}" class="p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                    </label>
                    <label class="flex items-center space-x-2">
                        <span>End Date:</span>
                        <input type="date" id="unitEndDateInput" value="${selectedUnit.endDate || ''}" class="p-2 rounded ${theme.inputBorder} ${theme.secondaryBg} ${theme.textColor}" />
                    </label>
                    <button id="updateDatesButton" class="px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}">Update Dates</button>
                </div>
            `;
            plannerDiv.appendChild(dateRangeDiv);

            const unitStartDateInput = dateRangeDiv.querySelector('#unitStartDateInput');
            const unitEndDateInput = dateRangeDiv.querySelector('#unitEndDateInput');
            dateRangeDiv.querySelector('#updateDatesButton').addEventListener('click', () => {
                const newStartDate = unitStartDateInput.value ? new Date(unitStartDateInput.value + 'T00:00:00') : null;
                const newEndDate = unitEndDateInput.value ? new Date(unitEndDateInput.value + 'T00:00:00') : null;
                if (newStartDate && newEndDate && newStartDate > newEndDate) {
                    showAppMessage('Start date cannot be after end date.', 'error');
                    return;
                }
                updateUnitDates(selectedUnit.id, newStartDate, newEndDate);
            });

            const filteredLessons = lessons.filter(lesson => lesson.unitId === selectedUnit.id);
            const weekdays = selectedUnit.startDate && selectedUnit.endDate ? getWeekdaysInRange(new Date(selectedUnit.startDate + 'T00:00:00'), new Date(selectedUnit.endDate + 'T00:00:00')) : [];

            // Centralized lessonsByDate creation using consistent ISO string keys
            const lessonsByDate = weekdays.reduce((acc, date) => {
                const dateISOString = date.toISOString().split('T')[0];
                acc[dateISOString] = filteredLessons
                    .filter(lesson => isSameDay(lesson.date, dateISOString))
                    .sort((a, b) => a.order - b.order);
                return acc;
            }, {});

            if (currentView === 'listView') {
                renderListView(plannerDiv, weekdays, lessonsByDate);
            } else if (currentView === 'weeklyView') {
                renderWeeklyView(plannerDiv, weekdays, lessonsByDate); // Pass lessonsByDate
            } else if (currentView === 'monthlyView') {
                renderMonthlyView(plannerDiv, weekdays, lessonsByDate, filteredLessons, selectedUnit.id);
            } else { // Default to list view if currentView is unrecognized (e.g., old 'weeklyView' state)
                currentView = 'listView';
                renderListView(plannerDiv, weekdays, lessonsByDate);
            }
        };

        const renderListView = (parentElement, weekdays, lessonsByDate) => {
            const theme = themes[currentTheme];
            const listViewContainer = document.createElement('div');
            listViewContainer.className = `p-4 rounded-lg shadow-md border ${theme.borderColor}`;
            parentElement.appendChild(listViewContainer);

            if (weekdays.length === 0) {
                listViewContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Please set a date range for this unit.</p>`;
                return;
            }

            const listContent = document.createElement('div');
            listContent.className = "flex flex-col";
            listViewContainer.appendChild(listContent);

            weekdays.forEach(date => {
                const dateISOString = date.toISOString().split('T')[0]; // Get ISO string for droppableId
                const dateRow = document.createElement('div');
                dateRow.className = `flex flex-col md:flex-row border-b last:border-b-0 py-4 droppable-date`; // Added droppable-date class
                dateRow.style.borderColor = theme.borderColor.split('-').pop();
                dateRow.dataset.droppableId = dateISOString; // Make date row a droppable target
                dateRow.addEventListener('dragover', handleDragOver); // Re-enabled drag-drop listeners
                dateRow.addEventListener('dragleave', handleDragLeave);
                dateRow.addEventListener('drop', handleDrop);

                const dateColumn = document.createElement('div');
                dateColumn.className = `flex flex-row md:flex-col items-center md:items-start justify-between md:justify-start pr-4 md:border-r md:w-1/4 flex-shrink-0 mb-2 md:mb-0`;
                dateColumn.style.borderColor = theme.borderColor.split('-').pop();
                dateColumn.innerHTML = `
                    <h3 class="text-xl font-semibold mb-0 md:mb-2">${formatDate(date)}</h3>
                    <button class="add-lesson-button w-8 h-8 flex items-center justify-center rounded-full text-lg font-bold transition duration-200 ease-in-out transform hover:scale-110 ${theme.buttonBg}" data-date="${dateISOString}">+</button>
                `;
                dateColumn.querySelector('.add-lesson-button').addEventListener('click', (e) => {
                    openModal('addLesson', { date: e.target.dataset.date });
                });
                dateRow.appendChild(dateColumn);

                const lessonsColumn = document.createElement('div');
                lessonsColumn.className = `flex-grow md:pl-4`;
                dateRow.appendChild(lessonsColumn);

                renderLessonList(lessonsColumn, lessonsByDate[dateISOString] || [], dateISOString, false); // Pass ISO string for droppableId
                listContent.appendChild(dateRow);
            });
        };

        // Weekly View (Redesigned to be a simple calendar)
        const renderWeeklyView = (parentElement, weekdays, lessonsByDate) => { // Removed allUnitLessons as it's not directly used here
            const theme = themes[currentTheme];
            const weeklyViewContainer = document.createElement('div');
            weeklyViewContainer.className = `space-y-8`;
            parentElement.appendChild(weeklyViewContainer);

            // Toggle for Student View
            const toggleContainer = document.createElement('div');
            toggleContainer.className = 'flex justify-end mb-4';
            const toggleButton = document.createElement('button');
            toggleButton.id = 'toggleWeeklyView';
            toggleButton.className = `px-4 py-2 rounded-xl font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${theme.buttonBg}`;
            toggleButton.textContent = isWeeklyStudentView ? 'Switch to Teacher View' : 'Switch to Student View';
            toggleButton.addEventListener('click', () => {
                isWeeklyStudentView = !isWeeklyStudentView;
                renderApp(); // Re-render to apply new view
            });
            toggleContainer.appendChild(toggleButton);
            weeklyViewContainer.appendChild(toggleContainer);


            if (weekdays.length === 0) {
                weeklyViewContainer.innerHTML += `<p class="text-center text-gray-500">Please set a date range for this unit.</p>`;
                return;
            }

            const weeks = [];
            let currentWeek = [];
            for (let i = 0; i < weekdays.length; i++) {
                currentWeek.push(weekdays[i]);
                if (currentWeek.length === 5 || i === weekdays.length - 1) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                } else if (weekdays[i + 1] && weekdays[i + 1].getDay() === 1) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
            }

            let gradedAssignmentsForWeek = []; 

            weeks.forEach((week, weekIndex) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = `p-4 rounded-lg shadow-md border ${theme.borderColor}`;
                weekDiv.innerHTML = `<h3 class="text-xl font-bold mb-4">Week of ${formatDate(week[0])} - ${formatDate(week[week.length - 1])}</h3>`;
                const daysGrid = document.createElement('div');
                daysGrid.className = `grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-5 gap-2`;
                weekDiv.appendChild(daysGrid);

                // Define the desired order of days for display (Monday to Friday)
                const orderedWeekdays = [1, 2, 3, 4, 5]; // Monday=1, Tuesday=2, ..., Friday=5

                orderedWeekdays.forEach(dayIndex => {
                    // Find the date object for the current dayIndex within the current week
                    const date = week.find(d => d.getDay() === dayIndex);
                    const dateISOString = date ? date.toISOString().split('T')[0] : null;

                    const dayCard = document.createElement('div');
                    dayCard.className = `p-3 rounded-lg border ${theme.borderColor} ${date ? theme.secondaryBg : 'bg-gray-100'} min-h-[200px] droppable-date`;
                    dayCard.dataset.droppableId = dateISOString;
                    dayCard.addEventListener('dragover', handleDragOver);
                    dayCard.addEventListener('dragleave', handleDragLeave);
                    dayCard.addEventListener('drop', handleDrop);

                    if (date) {
                        const lessonsForDay = lessonsByDate[dateISOString] || [];

                        // Create the day header strip
                        const dayHeaderStrip = document.createElement('div');
                        dayHeaderStrip.className = 'day-header-strip flex justify-between items-center mb-2';
                        
                        const dateSpan = document.createElement('span');
                        dateSpan.className = `font-bold ${isWeeklyStudentView ? 'text-lg' : 'text-sm'}`; // Larger date in student view
                        dateSpan.textContent = date.getDate(); // Just the day number
                        dayHeaderStrip.appendChild(dateSpan);

                        // Only add the plus button if it's the teacher view
                        if (!isWeeklyStudentView) {
                            const addButton = document.createElement('button');
                            addButton.className = `add-lesson-button w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold transition duration-200 ease-in-out transform hover:scale-110 ${theme.buttonBg}`;
                            addButton.textContent = '+';
                            addButton.dataset.date = dateISOString;
                            addButton.addEventListener('click', (e) => {
                                openModal('addLesson', { date: e.target.dataset.date });
                            });
                            dayHeaderStrip.appendChild(addButton);
                        }
                        dayCard.appendChild(dayHeaderStrip); // Append the header strip first

                        // Render lesson content
                        const lessonsContentArea = document.createElement('div');
                        lessonsContentArea.className = 'space-y-1'; 
                        dayCard.appendChild(lessonsContentArea);

                        if (!isWeeklyStudentView) { // Teacher View
                            renderLessonList(lessonsContentArea, lessonsForDay, dateISOString, false); // Full details
                        } else { // Student View
                            lessonsContentArea.innerHTML = lessonsForDay.map(lesson => `
                                <div class="p-2 rounded-lg ${lesson.isGraded ? `${theme.gradedBg} ${theme.gradedBorder} border` : 'bg-gray-50'}">
                                    <p class="font-bold text-base truncate">${escapeHtml(lesson.title)}</p>
                                    ${lesson.isGraded && lesson.activityAssignment ? `<p class="text-gray-700 truncate"><span class="font-bold">Assignment:</span> ${escapeHtml(lesson.activityAssignment)}</p>` : ''}
                                    ${lesson.readings ? `<p class="text-gray-600 truncate"><span class="font-bold">Readings:</span> ${escapeHtml(lesson.readings)}</p>` : ''}
                                </div>
                            `).join('');

                            lessonsForDay.filter(l => l.isGraded).forEach(l => {
                                gradedAssignmentsForWeek.push({
                                    title: l.title,
                                    assignment: l.activityAssignment,
                                    date: formatDate(date)
                                });
                            });
                        }
                    } else {
                        dayCard.innerHTML = `<div class="h-full"></div>`; // Empty cell for non-weekdays or outside range
                    }
                    daysGrid.appendChild(dayCard);
                });
                weekDiv.appendChild(daysGrid);
                weeklyViewContainer.appendChild(weekDiv);
            });

            if (isWeeklyStudentView) {
                const gradedAssignmentsSummary = document.createElement('div');
                gradedAssignmentsSummary.className = `p-4 rounded-lg shadow-md border ${theme.borderColor} mt-8`;
                gradedAssignmentsSummary.innerHTML = `<h3 class="text-xl font-bold mb-4">Graded Assignments for the Week</h3>`;
                
                if (gradedAssignmentsForWeek.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside space-y-1';
                    gradedAssignmentsForWeek.forEach(assignment => {
                        const li = document.createElement('li');
                        li.textContent = `${escapeHtml(assignment.title)}${assignment.assignment ? `: ${escapeHtml(assignment.assignment)}` : ''} (${escapeHtml(assignment.date)})`;
                        ul.appendChild(li);
                    });
                    gradedAssignmentsSummary.appendChild(ul);
                } else {
                    gradedAssignmentsSummary.innerHTML += `<p class="text-gray-500 italic">No graded assignments this week.</p>`;
                }
                weeklyViewContainer.appendChild(gradedAssignmentsSummary);
            }
        };

        const renderMonthlyView = (parentElement, weekdays, lessonsByDate, allUnitLessons, selectedUnitId) => { // Added lessonsByDate to params
            const theme = themes[currentTheme];
            const monthlyViewContainer = document.createElement('div');
            monthlyViewContainer.className = `p-4 rounded-lg shadow-md border ${theme.borderColor}`;
            parentElement.appendChild(monthlyViewContainer);

            // Initialize currentMonth based on selectedUnit's start date, otherwise default to today
            let currentMonthDate = selectedUnit && selectedUnit.startDate ? new Date(selectedUnit.startDate + 'T00:00:00') : new Date();

            const renderMonth = (monthDate) => {
                monthlyViewContainer.innerHTML = ''; // Clear previous month content

                const headerControls = document.createElement('div');
                headerControls.className = `flex justify-between items-center mb-4`;
                headerControls.innerHTML = `
                    <button id="prevMonthButton" class="${theme.buttonBg} px-3 py-1 rounded-xl font-semibold">&lt; Prev</button>
                    <h3 class="text-xl font-bold">${monthDate.toLocaleString('en-US', { month: 'long', year: 'numeric' })}</h3>
                    <button id="nextMonthButton" class="${theme.buttonBg} px-3 py-1 rounded-xl font-semibold">Next &gt;</button>
                `;
                monthlyViewContainer.appendChild(headerControls);

                headerControls.querySelector('#prevMonthButton').addEventListener('click', () => {
                    monthDate.setMonth(monthDate.getMonth() - 1);
                    renderMonth(monthDate);
                });
                headerControls.querySelector('#nextMonthButton').addEventListener('click', () => {
                    monthDate.setMonth(monthDate.getMonth() + 1);
                    renderMonth(monthDate);
                });

                const daysOfWeekHeader = document.createElement('div');
                daysOfWeekHeader.className = `grid grid-cols-7 gap-1 text-center font-semibold mb-2`;
                daysOfWeekHeader.innerHTML = `
                    <div class="py-2">Mon</div><div class="py-2">Tue</div><div class="py-2">Wed</div><div class="py-2">Thu</div><div class="py-2">Fri</div><div class="py-2">Sat</div><div class="py-2">Sun</div>
                `;
                monthlyViewContainer.appendChild(daysOfWeekHeader);

                const daysGrid = document.createElement('div');
                daysGrid.className = `grid grid-cols-7 gap-1`;
                monthlyViewContainer.appendChild(daysGrid);

                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const numDays = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday

                const daysInCalendar = [];
                // Add empty cells for days before the 1st of the month (adjusting for Monday start)
                for (let i = 0; i < (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); i++) {
                    daysInCalendar.push(null);
                }
                // Add actual days of the month
                for (let i = 1; i <= numDays; i++) {
                    daysInCalendar.push(new Date(year, month, i));
                }

                daysInCalendar.forEach((date, index) => {
                    const dateISOString = date ? date.toISOString().split('T')[0] : null; // Get ISO string for droppableId
                    const dayCell = document.createElement('div');
                    dayCell.className = `min-h-[180px] p-1 border ${theme.borderColor} ${date ? theme.secondaryBg : 'bg-gray-100'} ${date && (date.getDay() !== 0 && date.getDay() !== 6) ? 'droppable-date' : ''}`;
                    
                    if (date && (date.getDay() !== 0 && date.getDay() !== 6)) { // Only droppable for weekdays
                        dayCell.dataset.droppableId = dateISOString; // Make day cell a droppable target
                        dayCell.addEventListener('dragover', handleDragOver); // Re-enabled drag-drop listeners
                        dayCell.addEventListener('dragleave', handleDragLeave);
                        dayCell.addEventListener('drop', handleDrop);
                    }

                    if (date) {
                        const dayHeaderStrip = document.createElement('div');
                        dayHeaderStrip.className = 'day-header-strip flex justify-between items-center mb-1';
                        
                        const dateSpan = document.createElement('span');
                        dateSpan.className = 'font-bold text-sm';
                        dateSpan.textContent = date.getDate(); // Just the day number
                        dayHeaderStrip.appendChild(dateSpan);

                        const addButton = document.createElement('button');
                        addButton.className = `add-lesson-button w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold transition duration-200 ease-in-out transform hover:scale-110 ${theme.buttonBg}`;
                        addButton.textContent = '+';
                        addButton.dataset.date = dateISOString;
                        addButton.addEventListener('click', (e) => {
                            openModal('addLesson', { date: e.target.dataset.date });
                        });
                        dayHeaderStrip.appendChild(addButton);
                        dayCell.appendChild(dayHeaderStrip); // Append the header strip first
                        
                        // Lessons content area
                        const lessonsContentArea = document.createElement('div');
                        lessonsContentArea.className = 'space-y-1'; // Placeholder for consistency
                        dayCell.appendChild(lessonsContentArea);

                        const lessonsForDay = lessonsByDate[dateISOString] || []; // Use lessonsByDate for lookup
                        renderLessonList(lessonsContentArea, lessonsForDay, dateISOString, false); // Full details
                        
                    } else {
                        dayCell.innerHTML = `<div class="h-full"></div>`;
                    }
                    daysGrid.appendChild(dayCell);
                });
            };

            renderMonth(currentMonthDate); // Pass the initial month date
        };


        const renderLessonList = (parentElement, lessonsForDate, droppableId, isCompact) => {
            parentElement.innerHTML = ''; // Clear existing lessons
            const theme = themes[currentTheme];

            if (lessonsForDate.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-sm italic';
                p.textContent = 'No lessons planned.';
                parentElement.appendChild(p);
                return;
            }

            const listDiv = document.createElement('div');
            listDiv.className = 'space-y-1'; // More compact spacing
            parentElement.appendChild(listDiv);

            lessonsForDate.forEach((lesson, index) => {
                const lessonDiv = document.createElement('div');
                lessonDiv.className = `p-2 rounded-lg shadow-sm cursor-grab draggable-lesson ${lesson.isGraded ? `${theme.gradedBg} ${theme.gradedBorder} border-2` : `${theme.secondaryBg} border ${theme.borderColor}`} ${theme.hoverBg}`;
                lessonDiv.dataset.lessonId = lesson.id;
                lessonDiv.dataset.droppableId = droppableId; // Crucial: Add droppableId to the draggable element itself
                lessonDiv.draggable = true; // Re-enabled draggable attribute
                lessonDiv.addEventListener('dragstart', handleDragStart); // Re-enabled drag-drop listeners
                lessonDiv.addEventListener('dragend', handleDragEnd); // Re-enabled drag-drop listeners

                lessonDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg truncate">${escapeHtml(lesson.title)}</span> <!-- Larger and bolder title -->
                        <div class="flex space-x-1">
                            <button class="edit-lesson-button text-blue-500 hover:text-blue-700 text-sm" aria-label="Edit Lesson">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="delete-lesson-button text-red-500 hover:text-red-700 text-sm" aria-label="Delete Lesson">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="text-gray-600 text-sm mt-1">
                        ${lesson.activityAssignment ? `<p class="truncate"><span class="font-bold">Activity:</span> ${escapeHtml(lesson.activityAssignment)}</p>` : ''}
                        ${lesson.readings ? `<p class="truncate"><span class="font-bold">Readings:</span> ${escapeHtml(lesson.readings)}</p>` : ''}
                        ${lesson.googleSlidesLink ? `<p><a href="${escapeHtml(lesson.googleSlidesLink)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline truncate"><span class="font-bold">Slides Link</span></a></p>` : ''}
                        ${lesson.additionalLinks ? `<p class="truncate"><span class="font-bold">Links:</span> ${renderClickableLinks(lesson.additionalLinks)}</p>` : ''}
                    </div>
                `;
                lessonDiv.querySelector('.edit-lesson-button').addEventListener('click', () => openModal('editLesson', lesson));
                lessonDiv.querySelector('.delete-lesson-button').addEventListener('click', () => deleteLesson(lesson.id));
                listDiv.appendChild(lessonDiv);
            });
        };

        // --- Export/Import Functions ---
        const handleExportData = () => {
            const data = {
                units: units,
                lessons: lessons,
                userTabs: userTabs // Include userTabs in export
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            a.download = `lesson_planner_backup_${dateString}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAppMessage('Data exported successfully!', 'success');
        };

        const handleImportData = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.units && Array.isArray(importedData.units) &&
                        importedData.lessons && Array.isArray(importedData.lessons)) {
                        
                        units = importedData.units;
                        lessons = importedData.lessons;
                        userTabs = importedData.userTabs || []; // Import userTabs, default to empty array if not present
                        
                        if (units.length > 0) {
                            selectedUnit = units[0];
                        } else {
                            selectedUnit = null;
                        }
                        saveState();
                        renderApp();
                        showAppMessage('Data imported successfully!', 'success');
                    } else {
                        showAppMessage('Invalid file format. Please import a valid lesson planner JSON file.', 'error');
                    }
                } catch (error) {
                    console.error("Error importing data:", error);
                    showAppMessage('Error importing data. Make sure the file is a valid JSON.', 'error');
                }
            };
            reader.readAsText(file);
        };

        // --- Initial Load and Render ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderApp();
        });
    </script>
</body>
</html>
 
